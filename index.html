<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Baby Shower — Lista</title>
<style>
  :root { --rosa:#f8c7de; --rosa-osc:#e38db7; --fucsia:#d43f8d; --malva:#ffeef6; --gris:#6b7280; --rojo:#ef4444; }
  * { box-sizing:border-box; } body{margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,var(--malva),#fff 40%);color:#1f2937}
  .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:16px}
  .item{position:relative;border:1px solid #f5c5dd;border-radius:16px;padding:12px;background:linear-gradient(180deg,#fff,#fff9fc)}
  .item h3{font-size:16px;margin:0 0 6px;color:#7a214e}
  .tag{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;background:#ffe3f2;color:#7a214e;border:1px solid #ffd1ea}
  .badge{position:absolute;top:10px;right:10px;font-size:12px;padding:2px 8px;border-radius:999px;background:#fef3c7;border:1px solid #fde68a;color:#92400e}
  .desc{font-size:13px;color:var(--gris);margin:6px 0 10px;min-height:34px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{border-radius:12px;padding:8px 10px;font-weight:600;border:2px solid var(--rosa-osc);background:#fff;color:#7a214e;cursor:pointer}
  .primary{background:var(--rosa-osc);color:#fff;border-color:var(--fucsia)}
  .muted{border-color:#e5e7eb;color:#374151}
  .danger{border-color:var(--rojo);color:#991b1b}
</style>
</head>
<body>

<section id="grid" class="row"></section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, get, set } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

// 1) CONFIG — VERIFICA databaseURL
const firebaseConfig = {
  apiKey: "AIzaSyDqmNK2nF6KJsVcZFdP4VPHUKLiL89HIjg",
  authDomain: "babyshowergaby-4ce16.firebaseapp.com",
  databaseURL: "https://babyshowergaby-4ce16-default-rtdb.firebaseio.com", // <- EXACTO
  projectId: "babyshowergaby-4ce16",
  storageBucket: "babyshowergaby-4ce16.firebasestorage.app",
  messagingSenderId: "367031549351",
  appId: "1:367031549351:web:4b07dec773d4334dd20a82"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// 2) DATOS
const ADMIN_PHONE = "+593983379301";
const ITEMS = [
  { key:"it1",  title:"Biberones", tag:"Lactancia", note:"Anticólicos." },
  { key:"it2",  title:"Toallitas húmedas (x6)", tag:"Higiene", note:"Sin fragancia, para piel sensible." },
  { key:"it3",  title:"Crema anti-rozaduras", tag:"Higiene", note:"Con óxido de zinc." },
  { key:"it4",  title:"Shampoo & jabón neutro bebé", tag:"Baño", note:"pH suave, hipoalergénico." },
  { key:"it5",  title:"Bañera para bebé con soporte", tag:"Baño", note:"Con soporte antideslizante." },
  { key:"it6",  title:"Toallas con capucha (x2)", tag:"Baño", note:"Algodón suave." },
  { key:"it7",  title:"Manta/Swaddle muselina (x3)", tag:"Ropa & Ropa de cama", note:"Ligera para envolver." },
  { key:"it8",  title:"Mantitas afelpadas (x2)", tag:"Ropa & Ropa de cama", note:"Para abrigo." },
  { key:"it9",  title:"Babitas / Paños de eructo (x6)", tag:"Ropa & Ropa de cama", note:"Absorbentes." },
  { key:"it10", title:"Bodys manga corta 0–3m (x5)", tag:"Ropa", note:"Algodón 100%." },
  { key:"it11", title:"Bodys manga larga 3–6m (x5)", tag:"Ropa", note:"Para clima fresco." },
  { key:"it12", title:"Pijamas enterizas 0–3m (x4)", tag:"Ropa", note:"Con broches." },
  { key:"it13", title:"Medias y mitones (x6)", tag:"Ropa", note:"Protegen del frío y rasguños." },
  { key:"it14", title:"Gorritos algodón (x3)", tag:"Ropa", note:"Recién nacida." },
  { key:"it15", title:"Baberos (x6)", tag:"Alimentación", note:"Para leche y babeo." },
  { key:"it16", title:"Chupón + clip (x2)", tag:"Confort", note:"Silicona grado médico." },
  { key:"it17", title:"Cojín de lactancia", tag:"Lactancia", note:"Ergonómico." },
  { key:"it18", title:"Discos protectores lactancia", tag:"Lactancia", note:"Reutilizables o desechables." },
  { key:"it19", title:"Bolsas para leche materna", tag:"Lactancia", note:"Para congelar/guardar." },
  { key:"it20", title:"Portabebés tipo canguro", tag:"Paseo & Cambio", note:"Para salidas." },
  { key:"it21", title:"Detergente para bebé", tag:"Limpieza", note:"Hipoalergénico." },
  { key:"it22", title:"Cambiador color blanco", tag:"Paseo & Cambio", note:"Para salidas." },
  { key:"it23", title:"Colchita y sábanas para cuna (juego)", tag:"Ropa de cama", note:"Extras siempre útiles." },
  { key:"it24", title:"Pañales RN/0 (pack)", tag:"Higiene", note:"Hipoalergénicos." },
  { key:"it25", title:"Pañales RN/0 (pack) — Extra 1", tag:"Higiene", note:"Prioridad alta (recién nacidos)." },
  { key:"it26", title:"Pañales RN/0 (pack) — Extra 2", tag:"Higiene", note:"Prioridad alta (recién nacidos)." },
  { key:"it27", title:"Pañales Talla 1 (pack)", tag:"Higiene", note:"Para usar al mes 1–2." },
  { key:"it28", title:"Pañales Talla 1 (pack) — Extra", tag:"Higiene", note:"Stock adicional." },
  { key:"it29", title:"Pañales Talla 2 (pack)", tag:"Higiene", note:"Para meses 3–4." },
  { key:"it30", title:"Pañales Talla 3 (pack)", tag:"Higiene", note:"Para meses 5–6." },
  { key:"it31", title:"Pañales Talla 4 (pack)", tag:"Higiene", note:"Para meses 7–9." }
];

// Render
const grid = document.getElementById('grid');
grid.innerHTML = ITEMS.map(it => `
  <article class="item" data-key="${it.key}">
    <h3>${it.title}</h3>
    <span class="tag">${it.tag}</span>
    <span class="badge" data-badge="${it.key}"></span>
    <p class="desc">${it.note}</p>
    <div class="controls">
      <button class="primary" data-act="reserve" data-id="${it.key}">Reservar</button>
      <button class="muted" data-act="copy" data-id="${it.key}">Copiar</button>
    </div>
  </article>
`).join('');

// Estado en vivo
ITEMS.forEach(it => {
  const r = ref(db, `babyshower_gabriela/reservations/${it.key}`);
  onValue(r, (snap) => {
    const data = snap.val();
    const card  = document.querySelector(`[data-key="${it.key}"]`);
    const btn   = card?.querySelector(`button[data-act="reserve"][data-id="${it.key}"]`);
    const badge = card?.querySelector(`[data-badge="${it.key}"]`);
    let btnCancel = card?.querySelector(`button[data-act="cancel"][data-id="${it.key}"]`);

    if (data && data.reserved){
      if (btn){ btn.disabled = true; btn.textContent = "Ya reservado"; }
      if (badge){ badge.textContent = `Reservado por ${data.name || "—"}`; }
      if (!btnCancel){
        btnCancel = document.createElement("button");
        btnCancel.className = "danger";
        btnCancel.dataset.act = "cancel";
        btnCancel.dataset.id  = it.key;
        btnCancel.textContent = "Cancelar (PIN)";
        card.querySelector(".controls").appendChild(btnCancel);
      }
    } else {
      if (btn){ btn.disabled = false; btn.textContent = "Reservar"; }
      if (badge){ badge.textContent = ""; }
      if (btnCancel){ btnCancel.remove(); }
    }
  });
});

// Acciones
addEventListener('click', async (e) => {
  const b = e.target.closest('button'); if(!b) return;
  const act = b.dataset.act, id = b.dataset.id; if(!act || !id) return;
  const r = ref(db, `babyshower_gabriela/reservations/${id}`);

  if (act === 'copy'){
    const it = ITEMS.find(x=>x.key===id);
    await navigator.clipboard.writeText(`${it.title} — ${it.note}`);
    b.textContent = 'Copiado'; setTimeout(()=>b.textContent='Copiar',1200);
    return;
  }

  if (act === 'reserve'){
    const name = prompt('Escribe tu nombre para reservar:'); if(!name) return;
    // transacción: si ya está reservado, no sobrescribe
    try {
      const res = await runTransaction(r, (cur) => {
        if (cur && cur.reserved) return cur;
        return { reserved:true, name, ts: Date.now() };
      });
      if (!res.committed){ alert('Este artículo ya fue reservado por otra persona.'); return; }
      const it = ITEMS.find(x=>x.key===id);
      const text = `Hola, confirmo mi reserva para el Baby Shower de Gabriela Eloísa:%0A• Artículo: ${encodeURIComponent(it.title)}%0A• Nota: ${encodeURIComponent(it.note)}%0A• Mi nombre: ${encodeURIComponent(name)}`;
      const wa = `https://wa.me/${ADMIN_PHONE.replace('+','')}?text=${text}`;
      window.open(wa, '_blank');
    } catch(err){
      console.error(err); alert('No se pudo guardar la reserva. Revisa reglas/URL.');
    }
  }

  if (act === 'cancel'){
    const pin = prompt('PIN de anfitrión para cancelar:'); if(!pin) return;
    try {
      const snap = await get(r); const cur = snap.val();
      if (!cur || !cur.reserved){ alert('Este artículo no está reservado.'); return; }
      await set(r, { reserved:false, name: cur.name, ts: cur.ts, pin, cancelTs: Date.now() });
      alert('Reserva cancelada ✓');
    } catch(err){
      console.error(err); alert('No se pudo cancelar. Verifica PIN o reglas.');
    }
  }
});
</script>
</body>
</html>
